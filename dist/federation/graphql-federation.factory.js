"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphQLFederationFactory = void 0;
const tslib_1 = require("tslib");
const common_1 = require("@nestjs/common");
const load_package_util_1 = require("@nestjs/common/utils/load-package.util");
const shared_utils_1 = require("@nestjs/common/utils/shared.utils");
const apollo_graphql_1 = require("apollo-graphql");
const apollo_server_core_1 = require("apollo-server-core");
const graphql_1 = require("graphql");
const graphql_tools_1 = require("graphql-tools");
const lodash_1 = require("lodash");
const graphql_schema_builder_1 = require("../graphql-schema.builder");
const services_1 = require("../services");
const utils_1 = require("../utils");
let GraphQLFederationFactory = (() => {
    let GraphQLFederationFactory = class GraphQLFederationFactory {
        constructor(resolversExplorerService, scalarsExplorerService, pluginsExplorerService, gqlSchemaBuilder) {
            this.resolversExplorerService = resolversExplorerService;
            this.scalarsExplorerService = scalarsExplorerService;
            this.pluginsExplorerService = pluginsExplorerService;
            this.gqlSchemaBuilder = gqlSchemaBuilder;
        }
        mergeOptions(options = {}) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const transformSchema = (schema) => tslib_1.__awaiter(this, void 0, void 0, function* () { return options.transformSchema ? options.transformSchema(schema) : schema; });
                options.plugins = utils_1.extend(options.plugins || [], this.pluginsExplorerService.explore());
                let schema;
                if (options.autoSchemaFile) {
                    schema = yield this.generateSchema(options);
                }
                else if (lodash_1.isEmpty(options.typeDefs)) {
                    schema = options.schema;
                }
                else {
                    schema = this.buildSchemaFromTypeDefs(options);
                }
                return Object.assign(Object.assign({}, options), { schema: yield transformSchema(schema), typeDefs: undefined });
            });
        }
        buildSchemaFromTypeDefs(options) {
            const { buildFederatedSchema } = load_package_util_1.loadPackage('@apollo/federation', 'ApolloFederation', () => require('@apollo/federation'));
            return buildFederatedSchema([
                {
                    typeDefs: apollo_server_core_1.gql `
          ${options.typeDefs}
        `,
                    resolvers: this.getResolvers(options.resolvers),
                },
            ]);
        }
        generateSchema(options) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const { buildFederatedSchema, printSchema, } = load_package_util_1.loadPackage('@apollo/federation', 'ApolloFederation', () => require('@apollo/federation'));
                const autoGeneratedSchema = yield this.gqlSchemaBuilder.buildFederatedSchema(options.autoSchemaFile, options, this.resolversExplorerService.getAllCtors());
                let executableSchema = buildFederatedSchema({
                    typeDefs: apollo_server_core_1.gql(printSchema(autoGeneratedSchema)),
                    resolvers: this.getResolvers(options.resolvers),
                });
                executableSchema = this.overrideOrExtendResolvers(executableSchema, autoGeneratedSchema);
                const schema = options.schema
                    ? graphql_tools_1.mergeSchemas({
                        schemas: [options.schema, executableSchema],
                    })
                    : executableSchema;
                return schema;
            });
        }
        getResolvers(optionResolvers) {
            optionResolvers = Array.isArray(optionResolvers)
                ? optionResolvers
                : [optionResolvers];
            return this.extendResolvers([
                this.resolversExplorerService.explore(),
                ...this.scalarsExplorerService.explore(),
                ...optionResolvers,
            ]);
        }
        extendResolvers(resolvers) {
            return resolvers.reduce((prev, curr) => utils_1.extend(prev, curr), {});
        }
        overrideOrExtendResolvers(executableSchema, autoGeneratedSchema) {
            return apollo_graphql_1.transformSchema(executableSchema, (type) => {
                if (graphql_1.isUnionType(type) && type.name !== '_Entity') {
                    return this.overrideFederatedResolveType(type, autoGeneratedSchema);
                }
                else if (graphql_1.isInterfaceType(type)) {
                    return this.overrideFederatedResolveType(type, autoGeneratedSchema);
                }
                else if (graphql_1.isEnumType(type)) {
                    return autoGeneratedSchema.getType(type.name);
                }
                else if (graphql_1.isInputObjectType(type)) {
                    const autoGeneratedInputType = autoGeneratedSchema.getType(type.name);
                    if (!autoGeneratedInputType) {
                        return type;
                    }
                    const fields = type.getFields();
                    lodash_1.forEach(fields, (value, key) => {
                        const field = autoGeneratedInputType.getFields()[key];
                        if (!field) {
                            return;
                        }
                        value.extensions = field.extensions;
                        value.astNode = field.astNode;
                    });
                    type.extensions = autoGeneratedInputType.extensions;
                    return type;
                }
                else if (graphql_1.isObjectType(type)) {
                    const autoGeneratedObjectType = autoGeneratedSchema.getType(type.name);
                    if (!autoGeneratedObjectType) {
                        return type;
                    }
                    const fields = type.getFields();
                    lodash_1.forEach(fields, (value, key) => {
                        const field = autoGeneratedObjectType.getFields()[key];
                        if (!field) {
                            return;
                        }
                        value.extensions = field.extensions;
                        value.astNode = field.astNode;
                        if (!value.resolve) {
                            value.resolve = field.resolve;
                        }
                    });
                    type.extensions = autoGeneratedObjectType.extensions;
                    return type;
                }
                return type;
            });
        }
        overrideFederatedResolveType(typeInFederatedSchema, autoGeneratedSchema) {
            const autoGeneratedType = autoGeneratedSchema.getType(typeInFederatedSchema.name);
            if (!autoGeneratedType ||
                !(autoGeneratedType instanceof graphql_1.GraphQLUnionType) ||
                !autoGeneratedType.resolveType) {
                return typeInFederatedSchema;
            }
            typeInFederatedSchema.resolveType = (value, context, info, abstractType) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                const resultFromAutogenSchema = yield autoGeneratedType.resolveType(value, context, info, abstractType);
                if (!resultFromAutogenSchema || shared_utils_1.isString(resultFromAutogenSchema)) {
                    return resultFromAutogenSchema;
                }
                const resultFromFederatedSchema = info.schema.getType(resultFromAutogenSchema.name);
                if (resultFromFederatedSchema &&
                    resultFromFederatedSchema instanceof graphql_1.GraphQLObjectType) {
                    return resultFromFederatedSchema;
                }
                return resultFromAutogenSchema.name;
            });
            return typeInFederatedSchema;
        }
    };
    GraphQLFederationFactory = tslib_1.__decorate([
        common_1.Injectable(),
        tslib_1.__metadata("design:paramtypes", [services_1.ResolversExplorerService,
            services_1.ScalarsExplorerService,
            services_1.PluginsExplorerService,
            graphql_schema_builder_1.GraphQLSchemaBuilder])
    ], GraphQLFederationFactory);
    return GraphQLFederationFactory;
})();
exports.GraphQLFederationFactory = GraphQLFederationFactory;
